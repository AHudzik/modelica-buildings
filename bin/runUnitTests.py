#!/usr/bin/python
####################################################
# Script that writes runAll.mos, which runs all
# unit tests.
# This script searches for all mos files that
# contain the word simulate.
#
# MWetter@lbl.gov                        2009-040-10 
####################################################
import os, string, fnmatch, pwd, os.path
# --------------------------
LIBHOME=os.path.abspath(".")
MODELICA_EXE="dymola"

# Check wether the file 'fileName' contains the string 'key'
# as the first string on the first or second line
# If 'key' is found, increase the counter
def checkKey(key, fileName, counter):
        filObj=file(fileName)
        filTex=filObj.readline()
	# Strip white spaces so we can test strpos for zero.
        # This test returns non-zero for partial classes.
        filTex.strip()
        strpos=filTex.find("within")
        if strpos == 0:
            # first line is "within ...
            # get second line
            filTex=filObj.readline()
            filTex.strip()
        strpos=filTex.find(key)
        if strpos == 0:
            counter += 1;
        filObj.close()
        return counter
        
# --------------------------
def writeUnitTests(runFile):
    iRun=1
    for root, dirs, files in os.walk(LIBHOME):
        pos=string.find(root, 'svn')
        # skip svn folders
        if pos == -1:
            for filNam in files:
                # find .mos files
                pos=string.find(filNam, '.mos')
                if pos > -1:
                    # find files that contain simulate command
                    filFulNam=os.path.join(root, filNam)
                    filObj=file(filFulNam)
                    filTex=filObj.read()
                    strpos=filTex.find("simulate")
                    if strpos > -1:
                        runFile.write("RunScript(\"" + root + "/" + filNam + "\");\n")
                        iRun=iRun+1
                    filObj.close()
    print "Generated runAll.mos with %d unit tests.\n" % iRun

# --------------------------
def runSimulation(command):
    import sys
    from subprocess import call
    try:
	    retcode = call(command)
	    if retcode != 0:
		    print >>sys.stderr, "Child was terminated by signal", -retcode
    except OSError, e:
	    print >>sys.stderr, "Execution of ", command, " failed:", e

# --------------------------
def checkSimulationError(errorFile):
    import os.path
    import sys
    if os.path.exists(errorFile):
	    print >> sys.stderr, "*** Error: Unit tests had error(s)."
	    print >> sys.stderr, "    Search 'unitTests.log' for 'false' to see details."
	    fsock = open(errorFile, 'w')
	    sys.stderr = fsock
	    return 1
    else:
	    print >> sys.stdout, "Unit tests completed successfully."
	    return 0

		
# --------------------------
def countClasses(dir):
    iMod=0
    iBlo=0
    iFun=0
    for root, dirs, files in os.walk(LIBHOME):
        pos=string.find(root, 'svn')
        # skip svn folders
        if pos == -1:
            for filNam in files:
                # find .mo files
                pos=string.find(filNam, '.mo')
                posExa=string.find(root, 'Examples')
                if pos > -1 and posExa == -1:
                     # find classes that are not partial
                    filFulNam=os.path.join(root, filNam)
                    iMod = checkKey("model", filFulNam, iMod)
                    iBlo = checkKey("block", filFulNam, iBlo)
                    iFun = checkKey("function", filFulNam, iFun)
    print "Number of models   : %d" % iMod
    print "          blocks   : %d" % iBlo
    print "          functions: %d" % iFun
      
# --------------------------
# Write the script that runs all example problems, and
# that searches for errors
def writeRunscript():
    userName=pwd.getpwuid(os.getuid())[4]
    userName=userName.split(',')[0]
    runFil=open("runAll.mos", 'w')
    runFil.write("// File autogenerated by " + userName + ". Do not edit.\n")
    runFil.write("openModel(\"" + LIBHOME + "/package.mo\");\n")
    runFil.write("Modelica.Utilities.Files.remove(\"unitTests.log\");\n")
    runFil.write("Modelica.Utilities.Files.remove(\"failed.txt\");\n")
    writeUnitTests(runFil)
    runFil.write("// Save log file\n")
    runFil.write("savelog(\"unitTests.log\");\n")

    runFil.write("// Analyse\n")
    runFil.write("file = Modelica.Utilities.Streams.readFile(\"unitTests.log\");\n")
    runFil.write("n = size(file, 1);\n")
    runFil.write("found_on_index=0;\n")
    runFil.write("for i in 1:n loop\n")
    runFil.write("	found_on_index = Modelica.Utilities.Strings.find(file[i], \"false\");\n")
    runFil.write("	if found_on_index > 0 then\n")
    runFil.write("		Modelica.Utilities.Streams.print(\"Found false in unitTests.log on line \" + String(i), \"failed.txt\");\n")
    runFil.write("	end if;\n")
    runFil.write("end for;\n")
    runFil.write("exit\n")
    runFil.close()

curDir=os.path.split(os.path.abspath("."))[1]
if curDir == "Buildings":
    writeRunscript()
    countClasses(".")
    runSimulation([MODELICA_EXE, "runAll.mos", "/nowindow"])
    retVal=checkSimulationError("failed.txt")
else:
    print "*** This script must be run from the Buildings directory."
    print "*** Exit with error. Did not do anything."
    retVal=2

exit(retVal)
